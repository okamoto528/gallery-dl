# 重複ギャラリーファイル削除アプリ 仕様書 (Current)

## 1. 概要
指定されたディレクトリまたはEverything検索結果から **.cbz ファイル** をスキャンし、ID重複を検出して整理するアプリケーションです。
誤削除を防ぐため、直接削除は行わず、一旦「退避ディレクトリ」に移動させることを基本動作とします。

## 2. 動作要件

### 2.1 対象ファイル
*   **対象**: **.cbz ファイルのみ**。
    *   フォルダや他のアーカイブ形式（zip, rarなど）は対象外。
*   **識別**: ファイル名末尾の ID `(数字)` を基準に同一性を判定します。
    *   正規表現: `\((\d+)\)\.cbz$`
    *   例: `(1040451).cbz`

### 2.2 重複判定と優先順位
同一IDを持つファイルが複数存在する場合、以下のスコア計算を行い、最もスコアが高いものを**Winner（残存）**、それ以外を**Loser（移動対象）**とします。

1.  **スコア計算式**:
    ```python
    Score = (角括弧 '[' ']' および 丸括弧 '(' ')' の総数) * 10 + (ファイル名の文字数)
    ```
    *   タグ情報（`[Tag]`など）が多いファイルを優先します。
    *   タグ数が同じなら長いファイル名（詳細なタイトルなど）を優先します。

2.  **判定例**:
    *   ファイルA: `[Bazaar][Freud No Inmu] Title (Original) (1040451).cbz`
        *   括弧数: 6 ([], [], (), ()) -> 60点
        *   文字数: 50文字 (仮)
        *   合計: 110点
    *   ファイルB: `[Bazaar] Title (1040451).cbz`
        *   括弧数: 4 ([], ()) -> 40点
        *   文字数: 25文字 (仮)
        *   合計: 65点
    *   **判定**: ファイルAがWinner。

### 2.3 動作モード

#### ディレクトリ指定モード (`--dir`)
*   指定されたディレクトリを**再帰的**にスキャンします（サブディレクトリも含む）。
*   **注意**: 異なるディレクトリ間で重複があった場合も、比較・判定の対象となります。

#### Everything検索モード (`--keyword`)
*   指定されたキーワードに ` .cbz` を付加してEverything (es.exe) で検索します。
*   検索結果の `.cbz` ファイルのみを対象とします。

### 2.4 退避・削除処理 (`_trash`)
*   **退避先（Trash）の決定ロジック**:
    1.  **設定ファイル (`clean_duplicates.json`) がある場合**:
        *   設定された `trash_dir` へ**全ての削除対象ファイルを移動**します。
        *   元のディレクトリ階層に関わらず、指定された1つのフォルダに集約されます。
    2.  **設定ファイルがない場合（デフォルト）**:
        *   **各ファイルの親ディレクトリ内**に `_trash` フォルダを作成し、そこへ移動します。
        *   例: `D:\Comics\SubA\File.cbz` -> `D:\Comics\SubA\_trash\File.cbz`

*   **ファイル名重複時の処理**:
    *   移動先に同名ファイルがある場合、タイムスタンプを付与してリネームします。
    *   例: `FileB_1700000000.cbz`
*   **削除オプション (`--delete`)**:
    *   このオプションが指定された場合のみ、移動後に `_trash` 内の当該ファイルを削除します。
    *   デフォルト（指定なし）では移動のみを行い、ファイルは保持されます。

## 3. インターフェース
*   **コマンド**: `python clean_duplicates.py [引数] [オプション]`
*   **引数**:
    *   `--dir [PATH]`: 対象ディレクトリを指定。(`os.walk` で再帰探索)
    *   `--keyword [KEYWORD]`: Everything検索キーワード。
        *   **注意**: キーワードに**スペースが含まれる場合**は、必ずダブルクォートで囲んでください。
        *   例: `--keyword "[ogeretsu tanaka]"`
    *   ※どちらか必須。
*   **オプション**:
    *   `--dry-run`: 変更を行わず、判定結果のみを表示。
    *   `--delete`: 退避後にファイルを削除。

## 4. 依存関係
*   Standard Library (os, re, argparse, subprocess, shutil, sys, collections)
*   **External**: `es.exe` (Everything CLI) - Pathが通っていること（検索モード利用時のみ）
